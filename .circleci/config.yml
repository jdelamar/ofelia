# Golang CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-go/ for more details
version: 2
# Jobs

jobs:
  build:
    docker:
      - image: gcr.io/npav-172917/docker-go-sdk:dev-alpine
        auth:
          username: ${GCR_DOCKER_RO_USERNAME}
          password: ${GCR_DOCKER_RO_PASSWORD}

    working_directory: /root/go/src/github.com/mcuadros/ofelia

    steps:
      - checkout 

      - setup_remote_docker

      # - run:
      #     name: Login into docker repository
      #     command: docker login -u ${GCR_DOCKER_RO_USERNAME} -p "$(echo $GCR_DOCKER_RO_PASSWORD)" https://gcr.io

      # - run:
      #     name: Starting CouchDB
      #     command: docker run --rm -it -p 6684:5984 -d gcr.io/npav-172917/docker-couchdb:dev
    
      - run: 
          name: Downloading the dependency management tool
          command: go get -u github.com/golang/dep/cmd/dep

      - run:
          name: Download Dependencies
          command: ~/go/bin/dep ensure

      - run:
          name: Run Tests
          command: make test

      - run:
          name: Building the binaries
          command: make 

          ## Joel TODO: add here a command for scan - Scan codes only
  release:
    docker:
      - image: gcr.io/npav-172917/docker-go-sdk:dev-alpine
        auth:
          username: ${GCR_DOCKER_RO_USERNAME}
          password: ${GCR_DOCKER_RO_PASSWORD}

    working_directory: /root/go/src/github.com/mcuadros/ofelia

    steps:
      - checkout 

      - run: 
          name: Downloading the dependency management tool
          command: go get -u github.com/golang/dep/cmd/dep

      - run:
          name: Download Dependencies
          command: ~/go/bin/dep ensure

      - setup_remote_docker

      - run:
          name: unpacking service account
          command: |
            echo $GCLOUD_SERVICE_KEY | base64 -d  > ${HOME}/gcloud-service-key.json

      - run:
          name: Login into docker repository
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ] && [ "${CIRCLE_PROJECT_USERNAME}" == "Accedian" ]; then
              docker login -u _json_key -p "$(echo $GCR_DOCKER_RW_PASSWORD)" https://gcr.io
            fi

      - run:
          name: "Push image to GCR"
          command: |
            # Only push docker image when on master branch on the Accedian project
            if [[ "${CIRCLE_BRANCH}" == "master" || "${CIRCLE_BRANCH}" == "release/"* ]] && [ "${CIRCLE_PROJECT_USERNAME}" == "Accedian" ]; then
               echo "Now Tagging"
               git config --global user.email "${CIRCLE_USERNAME}@accedian.com"
               git config --global user.name "CircleCI"
               git semver minor
               export DOCKER_VER=$(git semver get)
               git push origin master ${DOCKER_VER}
               make -f Makefile.Accedian push
            fi

workflows:
  version: 2
  build_and_release:
    jobs:
      - build:
          context: org-global

      - release:
          context: org-global
          requires:
            - build  
          filters:
            branches:
              only: 
                - master
                - /release\/.*/
